generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String    @id @default(uuid())
  name                String
  email               String    @unique
  avatar              String?
  password            String
  phoneNumber         String?
  address             String?
  city                String?
  state               String?
  deliveryAddresses   Address[]
  role                String    @default("CUSTOMER")
  businessName        String?
  storeId             String?
  createdAt           DateTime  @default(now())
  resetPasswordToken  String?
  resetPasswordTime   DateTime?
  securityCode        String?
  securityCodeExpires DateTime?
  isApproved          Boolean   @default(false)
  approvalToken       String?

  store Store? @relation("UserStore")

  Cart Cart[]

  Order Order[]

  Wallet Wallet[]

  sentMessages     Message[] @relation("Sender")
  receivedMessages Message[] @relation("Receiver")
}

model PickupStation {
  id        String  @id @default(uuid())
  name      String
  addressId String
  address   Address @relation(fields: [addressId], references: [id])
}

model Address {
  id            String          @id @default(uuid())
  name          String
  mobileNo      String
  street        String
  city          String?
  state         String
  landmark      String
  postalCode    String?
  default       Boolean         @default(false)
  userId        String
  user          User            @relation(fields: [userId], references: [id])
  pickupStation PickupStation[]
}

model Store {
  id           String    @id @default(uuid())
  name         String
  businessName String
  phoneNumber  String
  email        String
  address      String
  city         String
  state        String
  ownerId      String    @unique
  products     Product[]

  owner User @relation("UserStore", fields: [ownerId], references: [id])

  OrderProduct OrderProduct[]
}

model Product {
  id            String      @id @default(uuid())
  name          String
  description   String
  images        String[]
  price         Float
  discountPrice Float?      @map("discount_price")
  categoryId    String
  subcategoryId String
  condition     String
  storeId       String
  variations    Variation[]
  ratings       Rating[]
  featured      Boolean
  totalSale     Int?        @map("total_sale")
  stock         Int
  brand         String?
  lastUpdated   DateTime    @default(now())

  category    Category          @relation(fields: [categoryId], references: [id])
  subcategory Subcategory       @relation(fields: [subcategoryId], references: [id], onDelete: Cascade)
  store       Store             @relation(fields: [storeId], references: [id])
  banners     BannerOnProduct[]

  CartItem CartItem[]

  OrderProduct OrderProduct[]
}

model Variation {
  id        String   @id @default(uuid())
  name      String
  options   String[]
  productId String

  product Product @relation(fields: [productId], references: [id])

  VariationSelection VariationSelection[]
}

model Banner {
  id             String            @id @default(uuid())
  name           String
  imageUrl       String
  linkedProducts BannerOnProduct[]
}

model BannerOnProduct {
  id        String @id @default(uuid())
  bannerId  String
  productId String

  banner  Banner  @relation(fields: [bannerId], references: [id])
  product Product @relation(fields: [productId], references: [id])

  @@unique([bannerId, productId])
}

model Rating {
  id        String @id @default(uuid())
  user      String
  rating    Float
  comment   String
  productId String

  product Product @relation(fields: [productId], references: [id])
}

model Category {
  id            String        @id @default(uuid())
  title         String
  subTitle      String
  imageUrl      String?
  subcategories Subcategory[] @relation("CategorySubcategories")
  products      Product[]
}

model Subcategory {
  id         String    @id @default(uuid())
  title      String
  imageUrl   String?
  categoryId String
  category   Category  @relation("CategorySubcategories", fields: [categoryId], references: [id], onDelete: Cascade)
  products   Product[]
}

model Cart {
  id     String     @id @default(uuid())
  user   User       @relation(fields: [userId], references: [id])
  userId String
  items  CartItem[]

  @@index([userId])
}

model CartItem {
  id                    String  @id @default(uuid())
  quantity              Int
  checked               Boolean
  selectedVariations    Json?
  shipmentOption        String?
  deliveryFee           Float?
  selectedCity          String?
  selectedState         String?
  selectedPickupStation String?
  selectedAddress       String?
  discountPrice         Float?
  productId             String
  cartId                String

  product Product @relation(fields: [productId], references: [id])
  cart    Cart    @relation(fields: [cartId], references: [id])

  VariationSelection VariationSelection[]
}

model VariationSelection {
  id             String    @id @default(uuid())
  variation      Variation @relation(fields: [variationId], references: [id])
  variationId    String
  selectedOption String
  cartItemId     String
  cartItem       CartItem  @relation(fields: [cartItemId], references: [id])
}

model Order {
  id             String         @id @default(uuid())
  products       OrderProduct[]
  userId         String
  user           User           @relation(fields: [userId], references: [id])
  status         String         @default("Pending")
  trackingNumber String?
  orderDate      DateTime       @default(now())
  paymentId      String?        @unique
  payment        OrderPayment?  @relation("OrderPayment")
  totalAmount    Float
  deliveryCharge Float?
  deliveryMethod String[]
  paymentMethod  String?
  type           String         @default("physical")
}

model OrderProduct {
  id                 String  @id @default(uuid())
  productId          String
  orderId            String
  storeId            String
  quantity           Int
  product            Product @relation(fields: [productId], references: [id])
  order              Order   @relation(fields: [orderId], references: [id])
  store              Store   @relation(fields: [storeId], references: [id])
  selectedVariations Json?
  deliveryCharge     Float?
}

model OrderPayment {
  id            String @id @default(uuid())
  orderId       String @unique
  order         Order? @relation("OrderPayment", fields: [orderId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  amount        Float
  transactionId String @default(uuid())
}

model Wallet {
  id      String @id @default(uuid())
  userId  String @unique
  user    User   @relation(fields: [userId], references: [id])
  balance Float  @default(0.0)
}

model PaymentMethod {
  id          String @id @default(uuid())
  method      String @unique
  displayName String
  provider    String
}

model Message {
  id         String   @id @default(uuid())
  content    String
  senderId   String
  receiverId String
  sentAt     DateTime @default(now())
  isRead     Boolean  @default(false)

  sender   User @relation("Sender", fields: [senderId], references: [id])
  receiver User @relation("Receiver", fields: [receiverId], references: [id])

  @@index([senderId])
  @@index([receiverId])
  @@index([sentAt])
}
